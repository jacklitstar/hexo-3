---
title: 家庭网络配置
date: 2024-10-16 23:30:00
---
在经历了一天的折腾之后，终于完成了网络配置!!简单记录一下过程。
先说一下我家的网络拓扑图，哦我的上帝，看到拓扑这两个字简直让人寒颤。 
1. 设备上：  
   一台迷你主机安装Windows Server 2022， 使用Hyper-V安装 Openwrt系统做软路由。一个无线路由器。光猫。一堆网线。
2. 物理上：  
   光纤入户到弱电箱，弱电箱放光猫，光猫有四个网口分别连接到墙里面去通往房间内的面板上，每个面板都有AP的无线功能。使用一根网线连接光猫（你的面板）与无线路由器的LAN口，另一根网线连接迷你主机的网口和无线路由器的另一个LAN口。这样即使是单网口的主机也可以配置。
3. 网络上：  
   本地网络为 10.0.1.0/24 所有设备都处在本地网络中（显然）。其中Hyper-V中的Openwrt 负责拨号上网，充当本地主路由。物理网络中有两层网络，其一：没有VLAN tag的（或者tag 为0）。这一层就是本地网络 10.0.1.0/24 其二：VLAN ID 为 41 的。这一层就是负责PPPOE拨号的，将Openwrt与光猫连接起来，进而与运营商通信。如果设置正确的话你的光猫会充当对于本地网络的交换机，让你其他房间的面板不用改线就能用。对VLAN 41的网络处理拨号上网。无线路由器也充当交换机，对两层网络（本地和VLAN 41）都交换。
# 获取光猫权限与宽带账号密码
这一步我直接问的我的运维师傅，师傅人很好直接给我了超密让我自己倒腾。宽带密码踩坑不少。用超级密码登录光猫后台，找到网络。首先是宽带账号，移动宽带在光猫里看到账号是 **1231231231@xxxx** 这种格式的，但是账号实际上只需要输入前面的数字就行。密码默认是888888，但是不知道为啥我的密码不对，于是只能打10086要求重置密码。
# 修改光猫配置
修改方法网上很多样，我这里记下原来的连接信息后将原来的网络配置删除。新建连接，选择桥接模式，VLAN选择透穿Transparent。选择透穿是因为我要做单线服用，相当于这个VLAN ID一直都打在数据报上面，并且不会经过光猫CPU，减小光猫因为性能问题造成的损失。互联网连接原来的VLAN ID 是 41，这里记下来。不用绑定端口。我打算把我的内网网段设置成 10.0.1.0/24 ，这需要修改掉原来光猫自带的路由功能。找到本地局域网选项，将IP设置一个本地网段的IP，我这里设置成了 10.0.1.3，关闭光猫的DHCP服务。光猫的配置就算完成了。
# 修改无线路由器设置
其实这里你的路由器已经没什么路由功能了，更多的是一个AP外加交换机。设置它为桥模式或者静态ip即可。静态ip需要时一个你内网中的ip，比如 10.0.1.2  我这里直接用的桥模式。需要打开你的无线路由器的VLAN 透穿 Transparent 功能，这样你的无线路由器不会丢掉带有VLAN标签的数据包。如果没有这个选项的话也不要紧，说不定你的路由器本身就不会丢弃带VLAN标签的数据包。先把软路由实体机网口连接到无线路由器的LAN口，再把光猫连接到无线路由器的LAN口。是的都是LAN口。
# Hyper-V 中配置 Openwrt 软路由
实体机安装Windows Server 2022 .跟着B站上的教程配置好除了与网络有关的项目，让Openwrt系统能够跑起来。然后修改网络配置。在虚拟交换机中创建一个（这里记为LAN，但是实际上并不是传统意义上的LAN，这里只是一个名字）并绑定一个实体机的物理接口，我们通过这一个接口实现单线服用。记得开启MAC地址伪装。这个接口物理上接你的无线路由器的LAN口。在虚拟机设置中配置两个网络适配器，第一个选择LAN。再创建一个，这个上面勾选VLAN 绑定，输入你记下来的VLAN ID，我这里输入41。Hyper-V的配置就算完成。  
在Openwrt中找到接口，将WAN口配置为eth1，即在Hyper-V虚拟机中打了标签的网络接口。不知道是哪个接口的可以 ifconfig 看看或者轮流试试。把接口模式改为PPPOE拨号，输入之前的拨号账号密码即可拨号上网。将Openwrt的br-lan的ip改为一个本地网络的IP地址作为本地网关，我这里设置了 10.0.1.1 开启本地DHCP服务即可。  
另外所有有关IPv6的配置电脑应该都能自动完成，只要你的设备都开启了IPv6有关的设置即可。

OK所有的配置到此就结束了，记住：折腾难免断网，不用害怕，多多尝试，发现问题解决问题。